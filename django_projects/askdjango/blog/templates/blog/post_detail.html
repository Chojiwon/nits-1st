{% extends "blog/base.html" %}

{% block content %}

<h1>{{ post.title }}</h1>

<p>by {{ post.author }}</p>

{% if post.photo %}
    <img src="{{ post.photo.url }}" />
    <ul>
        <li>
            url : {{ post.photo.url }}
        </li>
        <li>
            path : {{ post.photo.path }}
    </li>
    </ul>
{% endif %}

{{ post.content }}
<hr/>

<form id="comment_form" action="{% url "blog:comment_new" post.id %}" method="post">
    {% csrf_token %}
    <table>
        {{ comment_form.as_table }}
    </table>
    <input type="submit" class="btn btn-primary btn-block" />
</form>

<hr/>

<div id="comment_list">
    {% include "blog/comment_list.html" with comment_list=post.comment_set.all %}
</div>

<hr/>
<a href="{% url "blog:post_list" %}">목록</a>
<a href="{% url "blog:post_edit" post.pk %}">수정</a>
<a href="{% url "blog:comment_new" post.pk %}">댓글쓰기</a>
{% endblock %}

{% block extra_body %}
<script>
function refresh_comment_list() {
    $.get('{% url "blog:comment_list" post.pk %}').done(function(html) {
        $('#comment_list').html(html);
    });
}

$(function() {
    $('#comment_form').ajaxForm({
        success: function(response, statusText, xhr, $form) {
            if ( response.flash_message ) {
                $.toast(response.flash_message, {type: 'info', duration: 1500});
            }

            if ( response.errors ) {
                $.each(response.errors, function(key, error_messages) {
                    $.each(error_messages, function(index, message) {
                        $.toast(message, {type: 'danger', duration: 1500});
                    });
                });
            }
            else {
                refresh_comment_list();
            }
        }
    });

    // $('#comment_form').resetForm();

    $(document).on('click', '.ajax-post', function() {
        var url = $(this).attr('href');
        var message = $(this).data('confirm-message');
        if ( confirm(message) ) {
            $.post(url).done(function(response) {
                if ( response.flash_message ) {
                    $.toast(response.flash_message, {type: 'info', duration: 1500});
                }
                refresh_comment_list();
            });
        }
        return false;
    });
});
</script>
{% endblock %}

